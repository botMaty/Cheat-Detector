<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Cheating Detection Dashboard for exam analysis">
    <title>Cheating Detection Dashboard</title>
    <!-- Custom CSS -->
    <style>
        body {
            background-color: #f8f9fa;
        }
        .table-container {
            max-width: 1200px;
            margin: 2rem auto;
        }
        .percentage-high {
            color: #dc3545 !important;
            background-color: #f8d7da !important;
            font-weight: bold !important;
        }
        .percentage-medium {
            color: #fd7e14 !important;
            background-color: #fff3cd !important;
        }
        .percentage-low {
            color: #28a745 !important;
            background-color: #d4edda !important;
        }
        .percentage-no-cheat {
            color: #007bff !important;
            background-color: #cce5ff !important;
        }
        .loading-spinner {
            display: none;
        }
        .error-message {
            display: none;
            color: #dc3545;
        }
        .question-details {
            display: none;
        }
        .question-details.show {
            display: table-row;
        }
        .table th, .table td {
            vertical-align: middle;
        }
        .toggle-details {
            text-decoration: none;
        }
        .toggle-details:hover {
            text-decoration: underline;
        }
    </style>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body>
    <div class="container table-container">
        <h1 class="text-center mb-4">Cheating Detection Dashboard</h1>
        <div id="loading" class="loading-spinner text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        <div id="error" class="error-message text-center mb-3"></div>
        <table class="table table-striped table-hover table-bordered border-dark" id="cheatTable">
            <thead>
                <tr>
                    <th scope="col">Student Pair</th>
                    <th scope="col" class="text-end">
                        Overall Cheating Likelihood (%)
                        <button class="btn btn-sm btn-outline-secondary" id="sortBtn" aria-label="Sort by percentage">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-sort-down" viewBox="0 0 16 16">
                                <path d="M3.5 2.5a.5.5 0 0 0-1 0v8.793l-1.146-1.147a.5.5 0 0 0-.708.708l2 1.999.007.007a.497.497 0 0 0 .7-.006l2-2a.5.5 0 0 0-.707-.708L3.5 11.293V2.5zm3.5 1a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zM7.5 6a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5zm0 3a.5.5 0 0 0 0 1h3a.5.5 0 0 0 0-1h-3zm0 3a.5.5 0 0 0 0 1h1a.5.5 0 0 0 0-1h-1z"/>
                            </svg>
                        </button>
                    </th>
                </tr>
            </thead>
            <tbody id="cheatTableBody"></tbody>
        </table>
    </div>

    <!-- Bootstrap 5 JS and Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tableBody = document.getElementById('cheatTableBody');
            const loadingSpinner = document.getElementById('loading');
            const errorDiv = document.getElementById('error');
            const sortBtn = document.getElementById('sortBtn');
            let pairsData = [];
            let sortAscending = false;

            // Function to get percentage class for styling
            const getPercentageClass = (percentage) => {
                if (percentage >= 80) return 'percentage-high';
                if (percentage >= 50) return 'percentage-medium';
                if (percentage > 0) return 'percentage-low';
                return 'percentage-no-cheat';
            };

            // Function to get time class for styling
            const getTimeClass = (Time) => {
                if (Time <= 10) return 'percentage-high';
                if (Time <= 30) return 'percentage-medium';
                if (Time <= 60) return 'percentage-low';
                return 'percentage-no-cheat';
            };

            // Function to render table
            const renderTable = (pairs) => {
                tableBody.innerHTML = '';
                pairs.forEach((pair, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <button class="btn btn-link toggle-details" data-index="${index}" aria-expanded="false" aria-label="Toggle details for ${pair.student1} and ${pair.student2}">
                                ${pair.student1} & ${pair.student2}
                            </button>
                        </td>
                        <td class="text-end ${getPercentageClass(pair.overall_percentage)}">
                            ${pair.overall_percentage}%
                        </td>
                    `;
                    tableBody.appendChild(row);

                    // Add details row
                    const detailsRow = document.createElement('tr');
                    detailsRow.className = 'question-details';
                    detailsRow.id = `details-${index}`;
                    detailsRow.innerHTML = `
                        <td colspan="2">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Question</th>
                                        <th>Answer 1</th>
                                        <th>Answer 2</th>
                                        <th>SBERT Similarity</th>
                                        <th>TF-IDF Similarity</th>
                                        <th>Diff Similarity</th>
                                        <th>Time Diff (s)</th>
                                        <th>Cheating Likelihood (%)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${pair.answers_comparison.map(q => `
                                        <tr>
                                            <td>${q.qnumber}</td>
                                            <td>${q.answer1}</td>
                                            <td>${q.answer2}</td>
                                            <td class="${getPercentageClass(q.cosine_similarity_sbert * 100)}">
                                                ${(q.cosine_similarity_sbert * 100).toFixed(2)}%
                                            </td>
                                            <td class="${getPercentageClass(q.cosine_similarity_tfidf * 100)}">
                                                ${(q.cosine_similarity_tfidf * 100).toFixed(2)}%
                                            </td>
                                            <td class="${getPercentageClass(q.diff_similarity * 100)}">
                                                ${(q.diff_similarity * 100).toFixed(2)}%
                                            </td>
                                            <td class=${getTimeClass(q.time_difference)}>${q.time_difference !== null ? q.time_difference : 'N/A'}</td>
                                            <td class="${getPercentageClass(q.question_cheating_percentage)}">
                                                ${q.question_cheating_percentage}%
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </td>
                    `;
                    tableBody.appendChild(detailsRow);
                });
            };

            // Function to sort pairs
            const sortPairs = () => {
                pairsData.sort((a, b) => {
                    if (sortAscending) {
                        return a.overall_percentage - b.overall_percentage;
                    }
                    return b.overall_percentage - a.overall_percentage;
                });
                sortBtn.querySelector('svg').classList.toggle('bi-sort-down', !sortAscending);
                sortBtn.querySelector('svg').classList.toggle('bi-sort-up', sortAscending);
                renderTable(pairsData);
            };

            // Toggle sort direction
            sortBtn.addEventListener('click', () => {
                sortAscending = !sortAscending;
                sortPairs();
            });

            // Event delegation for toggle buttons
            tableBody.addEventListener('click', (e) => {
                const btn = e.target.closest('.toggle-details');
                if (btn) {
                    const index = btn.dataset.index;
                    const detailsRow = document.getElementById(`details-${index}`);
                    const isExpanded = btn.getAttribute('aria-expanded') === 'true';
                    detailsRow.classList.toggle('show', !isExpanded);
                    btn.setAttribute('aria-expanded', !isExpanded);
                }
            });

            // Fetch data from API
            const fetchData = async () => {
                loadingSpinner.style.display = 'block';
                errorDiv.style.display = 'none';
                try {
                    const response = await fetch('http://localhost:5000/cheat_detection');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    pairsData = data.pairs || [];
                    renderTable(pairsData);
                } catch (err) {
                    errorDiv.textContent = `Error: ${err.message}`;
                    errorDiv.style.display = 'block';
                    tableBody.innerHTML = '';
                } finally {
                    loadingSpinner.style.display = 'none';
                }
            };

            // Initial fetch
            fetchData();
        });
    </script>
</body>
</html>